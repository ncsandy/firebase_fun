<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <link rel="apple-touch-icon" sizes="76x76" href="./assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="./assets/img/favicon.png">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <title>
        Profile Page
    </title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
          name='viewport'/>
    <!--     Fonts and icons     -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet"/>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    <!-- CSS Files -->
    <link href="./assets/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="./assets/css/paper-dashboard.css?v=2.0.1" rel="stylesheet"/>
</head>

<body class="">
<div class="wrapper ">
    <div class="sidebar" data-color="white" data-active-color="danger">
        <div class="sidebar-wrapper">
            <ul class="nav">
                <li class="active ">
                    <a href="./user.html">
                        <i class="nc-icon nc-single-02"></i>
                        <p>User Profile</p>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    <div class="main-panel">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-absolute fixed-top navbar-transparent">
            <div class="container-fluid">
                <div class="navbar-wrapper">
                    <div class="navbar-toggle">
                        <button type="button" class="navbar-toggler">
                            <span class="navbar-toggler-bar bar1"></span>
                            <span class="navbar-toggler-bar bar2"></span>
                            <span class="navbar-toggler-bar bar3"></span>
                        </button>
                    </div>
                    <a class="navbar-brand" href="javascript:;">Firebase Project</a>
                </div>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation"
                        aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-bar navbar-kebab"></span>
                    <span class="navbar-toggler-bar navbar-kebab"></span>
                    <span class="navbar-toggler-bar navbar-kebab"></span>
                </button>
                <div class="collapse navbar-collapse justify-content-end" id="navigation">
                    <ul class="navbar-nav">
                        <li class="nav-item btn-rotate dropdown">
                            <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink"
                               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="nc-icon nc-bell-55"></i>
                                <p>
                                    <span class="d-lg-none d-md-block">Some Actions</span>
                                </p>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                                <a class="dropdown-item" href="#" id="signout">Sign out</a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- End Navbar -->
        <div class="content">
            <div class="row">
                <div class="col-md-4">
                    <div class="card card-user">
                        <div class="image">
                            <img src="./assets/img/damir-bosnjak.jpg" alt="...">
                        </div>
                        <div class="card-body">
                            <div class="author">
                                <a href="#">
                                    <img class="avatar border-gray" src="./assets/img/mike.jpg" alt="...">
                                    <h5 id = "username" class="title"></h5>
                                </a>
                                <p id="position_under" class="description">

                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card card-user">
                        <div class="card-header">
                            <h5 class="card-title">Edit Profile</h5>
                        </div>
                        <div class="card-body">
                            <form>
                                <div class="row">
                                    <div class="col-md-5 pr-1">
                                        <div class="form-group">
                                            <label>Name</label>
                                            <input type="text" class="form-control" id="usernameVal" disabled="" placeholder="" value="">
                                        </div>
                                    </div>
                                    <div class="col-md-4 pl-1">
                                        <div class="form-group">
                                            <label>Email address</label>
                                            <input type="email" class="form-control" id="emailVal" disabled="" placeholder="Email">
                                        </div>
                                    </div>
                                    <div class="col-md-5 pr-1">
                                        <div class="form-group">
                                            <label>Rank</label>
                                            <input type="text" id="rank" class="form-control" placeholder="" value="">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 pr-1">
                                        <div class="form-group">
                                            <label>Position</label>
                                            <input type="text" id="positionVal" class="form-control" placeholder="" value="">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="update ml-auto mr-auto">
                                        <button id="updateprofile" type="submit" class="btn btn-primary btn-round">Update Profile</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="footer footer-black  footer-white ">
            <div class="container-fluid">
                <div class="row">
                    <nav class="footer-nav">
                    </nav>
                    <div class="credits ml-auto">
              <span class="copyright">
                Â© <script>
                  document.write(new Date().getFullYear())
                </script>, made with <i class="fa fa-heart heart"></i> by Creative Tim
              </span>
                    </div>
                </div>
            </div>
        </footer>
    </div>
</div>
<!--   Core JS Files   -->
<script src="./assets/js/core/jquery.min.js"></script>
<script src="./assets/js/core/popper.min.js"></script>
<script src="./assets/js/core/bootstrap.min.js"></script>
<script src="./assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
<!-- Chart JS -->
<script src="./assets/js/plugins/chartjs.min.js"></script>
<!--  Notifications Plugin    -->
<script src="./assets/js/plugins/bootstrap-notify.js"></script>
<!-- Control Center for Now Ui Dashboard: parallax effects, scripts for the example pages etc -->
<script src="./assets/js/paper-dashboard.min.js?v=2.0.1" type="text/javascript"></script>
<!-- Paper Dashboard DEMO methods, don't include it in your project! -->
<script src="./assets/demo/demo.js"></script>
<script type="module">
    import {initializeApp} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
    // Add Firebase products that you want to use
    import {
        getAuth,
        onAuthStateChanged,
        signOut
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'
    import {
        getDatabase,
        ref,
        child,
        set,
        update,
        onValue,
        get
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js'

    const firebaseConfig = {
        apiKey: "AIzaSyDfS6FDvO1IzyDYdx14YPpmSWGBisNjiKg",
        authDomain: "simple-app-d3cee.firebaseapp.com",
        projectId: "simple-app-d3cee",
        storageBucket: "simple-app-d3cee.appspot.com",
        messagingSenderId: "377352501064",
        appId: "1:377352501064:web:716826c54b6df7930b257d",
        databaseUrl: "https://simple-app-d3cee-default-rtdb.firebaseio.com"
    };
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();
    let userUID = ''
    let username = ''

    window.onload = function () {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userUID = user.uid
                updateToDatabase(user)
                getUserData()
            } else {
                console.log('No signed in user')
                window.location.href = "./index.html";
            }
        })

        const signUserOut = document.getElementById("signout").onclick = (async (e) => {
            e.preventDefault()
            signOut(auth).then(() => {
            }).catch((error) => {
                console.log(error.message)
            });
        })

        function updateToDatabase(user) {
            try {
                update(ref(db, 'users/' + user.uid), {
                    last_login: getDate()
                })
            } catch (error) {
                const errorCode = error.code;
                const errorMessage = error.message;
                console.log(errorCode)
                console.log(errorMessage)
            }
        }

        function getDate() {
            return new Date().toLocaleString()
        }
        function getUserData() {
            const dbRef = ref(getDatabase());
            get(child(dbRef, `users/${userUID}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    populateData(snapshot)

                } else {
                    console.log("No data available");
                }
            }).catch((error) => {
                console.error(error);
            });
        }

        function populateData(snapshot) {

            const username = snapshot.child("username").val();
            const email = snapshot.child("email").val();
            const rank = snapshot.child("rank").val();
            const position = snapshot.child("position").val();

            document.getElementById('username').innerHTML = username
            document.getElementById("position_under").innerHTML = snapshot.child("position").val();
            document.getElementById('usernameVal').value = username
            document.getElementById('emailVal').value = email
            document.getElementById('rank').value = rank
            document.getElementById("positionVal").value = position
        }


        const updateProfileButton = document.getElementById("updateprofile").onclick = (async (e) => {
            e.preventDefault()

            const rank = document.getElementById("rank").value
            const position = document.getElementById("positionVal").value

            updateProfile(rank,position)
        })

        function updateProfile(rank, position) {
            try {
                update(ref(db, 'users/' + userUID), {
                    rank: rank,
                    position: position
                })
                window.location.href = "./user.html";

            } catch (error) {
                const errorCode = error.code;
                const errorMessage = error.message;
                console.log(errorCode)
                console.log(errorMessage)
            }
        }
    }
</script>
</body>
</html>

